{{define "main.html"}}
<!DOCTYPE html>
<html lang="en">
{{template "head" .}}
<body x-data="{ 
        sidebarsOpen: true,
        scrollProgress: 0
    }" 
    @scroll.window="scrollProgress = Math.round((window.pageYOffset / (document.documentElement.scrollHeight - document.documentElement.clientHeight)) * 100)"
    class="bg-white dark:bg-gray-900 overflow-x-hidden transition-colors duration-300">
    
    {{template "topbar" .}}
    
    <!-- Main Layout -->
    <div class="flex pt-16 min-h-screen">
        {{template "left-sidebar" .}}
        
        <!-- Main Content Area -->
        <main class="flex-1 bg-white dark:bg-gray-900 transition-colors duration-300">
            <div class="flex">
                <!-- Content Area -->
                <div class="flex-1 px-8 pt-16 pb-4">
                    <div class="max-w-6xl mx-auto">
                        {{if .IsMarkdown}}
                        <div class="py-20 prose prose-lg prose-slate dark:prose-invert max-w-none prose-headings:text-gray-900 dark:prose-headings:text-gray-100 prose-p:text-gray-700 dark:prose-p:text-gray-300 prose-strong:text-gray-900 dark:prose-strong:text-gray-100 prose-code:text-blue-600 dark:prose-code:text-blue-400 prose-code:bg-blue-50 dark:prose-code:bg-blue-950/30 prose-code:px-1 prose-code:py-0.5 prose-code:rounded">
                            {{if .Frontmatter}}
                            {{template "page-heading" (dict "Title" .Frontmatter.Title "Subtitle" .Frontmatter.Description "MarginBottom" "mb-8")}}
                            <hr class="mt-1 mb-8 border-gray-200 dark:border-gray-700">
                            {{end}}
                            {{.Content}}
                        </div>
                        {{else}}
                        {{.Content}}
                        {{end}}
                        
                        <!-- Copyright Notice -->
                        <div class="text-center mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <span class="text-sm leading-6 text-gray-600 dark:text-gray-400">¬© Blue <span x-text="new Date().getFullYear()"></span> ‚Äî Designed with <span class="text-red-500 animate-pulse">‚ù§</span> across the üåè</span>
                        </div>
                    </div>
                </div>
                
                {{template "right-sidebar" .}}
            </div>
        </main>
    </div>
    

    <script>       
        // Client-side routing for smooth navigation
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Highlight.js
            hljs.highlightAll();
            
            function addCopyButtons() {
                const codeBlocks = document.querySelectorAll('.prose pre:not([data-copy-added])');
                codeBlocks.forEach(pre => {
                    pre.setAttribute('data-copy-added', 'true');
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'code-copy-btn';
                    copyBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor"><use href="/public/icons/sprite.svg#copy"></use></svg>';
                    copyBtn.title = 'Copy code';
                    
                    copyBtn.addEventListener('click', async () => {
                        const code = pre.querySelector('code');
                        const text = code ? code.textContent : pre.textContent;
                        
                        try {
                            await navigator.clipboard.writeText(text);
                            copyBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor"><use href="/public/icons/sprite.svg#check"></use></svg>';
                            copyBtn.classList.add('copied');
                            copyBtn.title = 'Copied!';
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor"><use href="/public/icons/sprite.svg#copy"></use></svg>';
                                copyBtn.classList.remove('copied');
                                copyBtn.title = 'Copy code';
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    });
                    
                    pre.appendChild(copyBtn);
                });
            }
            
            function setupClientRouting() {
                const navLinks = document.querySelectorAll('a[href^="/"]:not([data-spa-handled])');
                navLinks.forEach(link => {
                    // Skip external links, special links, and pages with dynamic scripts
                    if (link.target === '_blank' || link.href.includes('#')) return;
                    
                    // Skip SPA routing for pages that need full page loads
                    const url = new URL(link.href);
                    const skipSPA = ['/platform/status'].includes(url.pathname);
                    if (skipSPA) return;
                    
                    // Mark as handled to prevent duplicate listeners
                    link.setAttribute('data-spa-handled', 'true');
                    
                    // Prefetch on hover
                    link.addEventListener('mouseenter', () => {
                        const prefetchLink = document.createElement('link');
                        prefetchLink.rel = 'prefetch';
                        prefetchLink.href = link.href;
                        document.head.appendChild(prefetchLink);
                    });
                    
                    // Handle click
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        
                        try {
                            const response = await fetch(link.href);
                            if (!response.ok) throw new Error('Network response was not ok');
                            
                            const html = await response.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            
                            const newMain = doc.querySelector('main');
                            const currentMain = document.querySelector('main');
                            
                            if (newMain && currentMain) {
                                // Fade out current content
                                currentMain.style.opacity = '0';
                                currentMain.style.transition = 'opacity 150ms ease-out';
                                
                                // Update content after fade out
                                setTimeout(() => {
                                    currentMain.innerHTML = newMain.innerHTML;
                                    // Fade in new content
                                    currentMain.style.opacity = '1';
                                    
                                    // Update title
                                    const newTitle = doc.querySelector('title');
                                    if (newTitle) document.title = newTitle.textContent;
                                    
                                    // Update meta tags for SEO
                                    ['description', 'og:title', 'og:description', 'og:url', 'twitter:title', 'twitter:description'].forEach(name => {
                                        const oldMeta = document.querySelector(`meta[name="${name}"], meta[property="${name}"]`);
                                        const newMeta = doc.querySelector(`meta[name="${name}"], meta[property="${name}"]`);
                                        if (oldMeta && newMeta) {
                                            if (oldMeta.hasAttribute('content')) {
                                                oldMeta.content = newMeta.content;
                                            } else if (oldMeta.hasAttribute('property')) {
                                                oldMeta.setAttribute('content', newMeta.content);
                                            }
                                        }
                                    });
                                    
                                    // Update URL
                                    window.history.pushState(null, '', link.href);
                                    
                                    // Update sidebar active state
                                    const sidebar = document.querySelector('nav[x-data*="currentPath"]');
                                    if (sidebar && sidebar._x_dataStack && sidebar._x_dataStack[0].updateCurrentPath) {
                                        sidebar._x_dataStack[0].updateCurrentPath(new URL(link.href).pathname);
                                    }
                                    
                                    // Re-initialize content
                                    hljs.highlightAll();
                                    addCopyButtons();
                                    setupClientRouting();
                                    
                                    // For pages with Alpine.js content (like insights), re-setup after Alpine renders
                                    if (new URL(link.href).pathname === '/insights') {
                                        setTimeout(() => {
                                            setupClientRouting();
                                        }, 100);
                                    }
                                    
                                    // Scroll to top
                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                }, 150);
                                
                            } else {
                                window.location.href = link.href;
                            }
                        } catch (error) {
                            console.error('Client routing failed:', error);
                            window.location.href = link.href;
                        }
                    });
                });
            }
            
            // Handle browser back/forward
            window.addEventListener('popstate', () => {
                // Update sidebar active state for browser navigation
                const sidebar = document.querySelector('nav[x-data*="currentPath"]');
                if (sidebar && sidebar._x_dataStack && sidebar._x_dataStack[0].updateCurrentPath) {
                    sidebar._x_dataStack[0].updateCurrentPath(window.location.pathname);
                }
                window.location.reload();
            });
            
            // Initialize
            addCopyButtons();
            setupClientRouting();
            
            // Re-setup routing after Alpine.js renders (for dynamically shown/hidden content)
            setTimeout(() => {
                setupClientRouting();
            }, 100);
        });
    </script>
</body>
</html>
{{end}}