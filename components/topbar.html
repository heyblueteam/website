{{define "topbar"}}
<div x-data="{ 
    mobileMenuOpen: false,
    darkMode: false,
    newsBarDismissed: false,
    magneticButtons: {},
    scrolled: false,
    customLogoUrl: null,
    init() {
        // Initialize dark mode from localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            this.darkMode = true;
            document.documentElement.classList.add('dark');
        } else {
            this.darkMode = false;
            document.documentElement.classList.remove('dark');
        }
        
        // Initialize news bar dismissal state
        this.newsBarDismissed = localStorage.getItem('topNewsBarDismissed') === 'true';
        
        // Initialize custom logo from localStorage
        this.customLogoUrl = localStorage.getItem('customLogo');
        
        // Listen for logo change events
        window.addEventListener('logoChanged', (event) => {
            this.customLogoUrl = event.detail.logoUrl;
        });
        
        // Initialize scroll detection
        this.handleScroll = () => {
            this.scrolled = window.scrollY > 50;
        };
        window.addEventListener('scroll', this.handleScroll);
        this.handleScroll();
    },
    toggleDarkMode() {
        this.darkMode = !this.darkMode;
        if (this.darkMode) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    },
    dismissNewsBar() {
        this.newsBarDismissed = true;
        localStorage.setItem('topNewsBarDismissed', 'true');
    },
    handleMagnetic(event, buttonId) {
        const element = event.currentTarget;
        const rect = element.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // Calculate distance from center (max 4px movement)
        const x = Math.max(-4, Math.min(4, (event.clientX - centerX) * 0.15));
        const y = Math.max(-4, Math.min(4, (event.clientY - centerY) * 0.15));
        
        this.magneticButtons[buttonId] = { x, y };
    },
    resetMagnetic(buttonId) {
        this.magneticButtons[buttonId] = { x: 0, y: 0 };
    },
    getMagneticStyle(buttonId) {
        const pos = this.magneticButtons[buttonId] || { x: 0, y: 0 };
        return `transform: translate(${pos.x}px, ${pos.y}px);`;
    }
}">
<!-- News Bar -->
<div x-show="!newsBarDismissed"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 -translate-y-full"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 -translate-y-full"
     class="hidden md:block fixed top-0 left-0 right-0 z-[60] bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
    <div class="relative flex items-center justify-center px-4 py-2.5 text-sm">
        <!-- Announcement content -->
        <div class="flex items-center space-x-2 text-gray-700 dark:text-gray-300">
            <!-- Message -->
            <span class="font-medium">ðŸ“š New website and documentation! Everything you need to know about Blue in one place.</span>
            
            <!-- CTA link -->
            <a :href="'/docs'" class="text-brand-blue dark:text-blue-400 font-semibold hover:underline underline-offset-2 ml-1">
                Explore docs â†’
            </a>
        </div>
        
        <!-- Dismiss button -->
        <button @click="dismissNewsBar()" 
                class="absolute right-4 p-1 rounded-md text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                aria-label="Dismiss announcement">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Scroll Indicator -->
<div class="fixed top-0 left-0 w-full h-1 z-[60] md:top-10"
     :class="newsBarDismissed ? 'md:!top-0' : ''">
    <div class="h-1 bg-gradient-to-r from-blue-100 transition-all duration-300 ease-out"
         :style="'width: ' + scrollProgress + '%; background-image: linear-gradient(to right, #dbeafe, #00a0d2);'"></div>
</div>

<!-- Top Navigation Bar -->
<header class="bg-white/70 dark:bg-gray-900/70 backdrop-blur-xl backdrop-saturate-150 fixed z-50 h-16 transition-all duration-300 left-0 right-0 xl:left-1/2 xl:-translate-x-1/2"
        :class="[
            newsBarDismissed ? 'top-0 md:top-0' : 'top-0 md:top-10',
            scrolled ? 'xl:top-4 xl:w-[85%] 2xl:w-[80%] xl:rounded-2xl xl:shadow-lg' : 'xl:w-full'
        ]"
        :style="scrolled ? 'box-shadow: 0 -10px 15px -3px rgb(0 0 0 / 0.1), 0 -4px 6px -4px rgb(0 0 0 / 0.1), 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);' : ''"
        @keydown.escape="mobileMenuOpen = false">
    <div class="relative flex items-center justify-between px-4 h-full">
        <!-- Logo and Toggle -->
        <div class="flex items-center">
            <a :href="'/'" class="flex items-center" 
               @click="window.dispatchEvent(new CustomEvent('collapse-sidebar-menus'))">
                <img :src="customLogoUrl || '/logo/logo.svg'" 
                     :alt="customLogoUrl ? 'Custom Logo' : 'Blue'" 
                     class="h-8 w-auto ml-3 transition-all duration-[400ms] hover:drop-shadow-[0_0_20px_rgba(0,160,210,0.3)] hover:brightness-110 hover:hue-rotate-[5deg]" 
                     style="transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);"
                     @error="customLogoUrl = null"
                     width="120" height="32">
            </a>
            <button @click="sidebarsOpen = !sidebarsOpen" 
                    class="hidden md:block p-2 ml-4 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 cursor-pointer focus:outline-none"
                    aria-label="Toggle sidebar">
                <svg class="w-4 h-6" fill="none" stroke="currentColor" viewBox="0 0 16 24">
                    <rect x="1" y="4" width="14" height="16" stroke-width="1.5" rx="1"></rect>
                    <rect :class="sidebarsOpen ? 'fill-current' : 'fill-transparent'" 
                          x="1" y="4" width="7" height="16" rx="1" 
                          class="transition-all duration-300"></rect>
                </svg>
            </button>
        </div>
        
        <!-- Search Bar Component -->
        {{template "search-bar" .}}
        
        <!-- Right side controls -->
        <div class="hidden md:flex items-center space-x-4">
            <!-- Light/Dark mode toggle -->
            <button @click="toggleDarkMode()" 
                    class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none transition-colors duration-200 cursor-pointer"
                    :aria-label="darkMode ? 'Switch to light mode' : 'Switch to dark mode'">
                <svg x-show="darkMode" x-cloak class="w-5 h-5 transition-transform duration-200" fill="currentColor">
                    <use href="/icons/sprite.svg#sun"></use>
                </svg>
                <svg x-show="!darkMode" x-cloak class="w-5 h-5 transition-transform duration-200" fill="currentColor">
                    <use href="/icons/sprite.svg#moon"></use>
                </svg>
            </button>
            
            <!-- Login -->
            <a href="https://app.blue.cc" 
               target="_blank" 
               @mousemove="handleMagnetic($event, 'login')"
               @mouseleave="loginHovering = false; resetMagnetic('login')"
               :style="getMagneticStyle('login')"
               class="relative px-4 py-2 text-sm font-semibold rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none transition-all duration-200 ease-out flex items-center overflow-hidden"
               x-data="{ loginHovering: false }"
               @mouseenter="loginHovering = true">
                <span class="relative h-5 overflow-hidden inline-block">
                    <span class="block transition-transform duration-300"
                          :class="loginHovering ? '-translate-y-5' : 'translate-y-0'">Log In</span>
                    <span class="block transition-transform duration-300"
                          :class="loginHovering ? '-translate-y-5' : 'translate-y-0'">Launch</span>
                </span>
                <span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-gray-200 rounded text-xs font-bold text-gray-700 border border-gray-300 transition-transform duration-200"
                      :style="magneticButtons['login'] ? `transform: translateX(${magneticButtons['login'].x * 0.5}px)` : ''">L</span>
            </a>
            
            <!-- Contact -->
            <a :href="'/contact'" 
               @mousemove="handleMagnetic($event, 'contact')"
               @mouseleave="contactHovering = false; resetMagnetic('contact')"
               :style="getMagneticStyle('contact')"
               class="hidden xl:flex relative px-4 py-2 text-sm font-semibold rounded-md border-2 border-brand-blue bg-blue-50 text-gray-900 hover:bg-blue-100 focus:outline-none transition-all duration-200 ease-out items-center cursor-pointer overflow-hidden"
               x-data="{ contactHovering: false }"
               @mouseenter="contactHovering = true">
                <span class="relative h-5 overflow-hidden inline-block">
                    <span class="block transition-transform duration-300"
                          :class="contactHovering ? '-translate-y-5' : 'translate-y-0'">Contact</span>
                    <span class="block transition-transform duration-300"
                          :class="contactHovering ? '-translate-y-5' : 'translate-y-0'">Connect</span>
                </span>
                <span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-gray-200 rounded text-xs font-bold text-gray-700 border border-gray-300 transition-transform duration-200"
                      :style="magneticButtons['contact'] ? `transform: translateX(${magneticButtons['contact'].x * 0.5}px)` : ''">C</span>
            </a>
            
            <!-- Sign Up -->
            <a href="https://app.blue.cc" 
               target="_blank" 
               @mousemove="handleMagnetic($event, 'signup')"
               @mouseleave="hovering = false; resetMagnetic('signup')"
               :style="getMagneticStyle('signup')"
               class="relative px-4 py-2 text-sm font-semibold rounded-md border border-transparent bg-brand-blue text-white hover:bg-brand-blue/90 focus:outline-none transition-all duration-200 ease-out flex items-center hover:shadow-lg overflow-hidden"
               x-data="{ hovering: false }"
               @mouseenter="hovering = true">
                <span class="relative h-5 overflow-hidden inline-block">
                    <span class="block transition-transform duration-300"
                          :class="hovering ? '-translate-y-5' : 'translate-y-0'">Sign Up</span>
                    <span class="block transition-transform duration-300"
                          :class="hovering ? '-translate-y-5' : 'translate-y-0'">Try Blue</span>
                </span>
                <span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-white rounded text-xs font-bold transition-transform duration-200 border" 
                      :style="`color: #00a0d2; border-color: #00a0d2; ${magneticButtons['signup'] ? 'transform: translateX(' + (magneticButtons['signup'].x * 0.5) + 'px)' : ''}`">â†µ</span>
            </a>
        </div>
        
        <!-- Mobile Menu Button -->
        <button @click="mobileMenuOpen = !mobileMenuOpen" 
                class="md:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 cursor-pointer focus:outline-none"
                :aria-label="mobileMenuOpen ? 'Close mobile menu' : 'Open mobile menu'">
            <svg x-show="!mobileMenuOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <svg x-show="mobileMenuOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    
    <!-- Keyboard shortcuts script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function openLogin() {
                window.open('https://app.blue.cc', '_blank');
            }

            function openSignUp() {
                window.open('https://app.blue.cc', '_blank');
            }

            function handleKeyPress(event) {
                // Check if the active element is an input, textarea, or any element within a form
                const activeElement = document.activeElement;
                const isFormElement = activeElement.tagName === 'INPUT' ||
                                    activeElement.tagName === 'TEXTAREA' ||
                                    activeElement.tagName === 'SELECT' ||
                                    activeElement.isContentEditable ||
                                    activeElement.closest('form') !== null;

                // Handle Cmd+K / Ctrl+K for search (works globally)
                if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'k') {
                    event.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                    return;
                }
                
                // Handle "/" for search (only when not in a form element)
                if (!isFormElement && event.key === '/') {
                    event.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                    return;
                }

                // Only proceed with other shortcuts if not interacting with a form element
                // and no modifier keys are pressed
                if (!isFormElement && !event.metaKey && !event.ctrlKey && !event.altKey && !event.shiftKey) {
                    if (event.key.toLowerCase() === 'l') {
                        event.preventDefault();
                        openLogin();
                    } else if (event.key.toLowerCase() === 'c') {
                        event.preventDefault();
                        // Find and click the contact link to use SPA routing
                        const contactLink = document.querySelector('a[href="/contact"]');
                        if (contactLink) {
                            contactLink.click();
                        } else {
                            // Fallback to direct navigation if link not found
                            window.location.href = '/contact';
                        }
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        openSignUp();
                    }
                }
            }

            document.addEventListener('keydown', handleKeyPress);
        });
    </script>
</header>

<!-- Mobile Menu Overlay -->
<div x-show="mobileMenuOpen"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     @click="mobileMenuOpen = false"
     class="md:hidden fixed inset-0 z-40"
     style="top: 64px">
    
    <!-- Mobile Menu Panel -->
    <div x-show="mobileMenuOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         @click.stop
         class="absolute right-0 top-0 h-full w-80 bg-white dark:bg-gray-900 shadow-xl overflow-y-auto"
         x-data="{ 
             sections: {{.Navigation.Sections | toJSON}},
             currentPath: window.location.pathname,
             init() {
                 // Ensure all sections start collapsed
                 this.sections.forEach(section => {
                     section.expanded = false;
                     if (section.children) {
                         section.children.forEach(child => {
                             child.expanded = false;
                         });
                     }
                 });
             },
             isActive(href) {
                 return this.currentPath === href || this.currentPath === href + '/' || this.currentPath + '/' === href;
             }
         }">
        <div class="p-4">
            <!-- Mobile Navigation -->
            <nav class="space-y-1">
                <template x-for="section in sections" :key="section.id">
                    <div class="mb-2">
                        <!-- Section has children -->
                        <template x-if="section.children && section.children.length > 0">
                            <div>
                                <button @click="sections.forEach(s => { if(s.id !== section.id) s.expanded = false; }); section.expanded = !section.expanded" 
                                        class="flex items-center justify-between w-full text-left px-3 py-2 rounded-lg text-gray-900 hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-sm" x-text="section.name"></span>
                                    <svg :class="section.expanded ? 'rotate-90' : 'rotate-0'" 
                                         class="w-4 h-4 text-gray-400 transition-transform duration-200" 
                                         fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                <div x-show="section.expanded" x-collapse class="ml-4 mt-1 space-y-1">
                                    <template x-for="child in section.children" :key="child.id">
                                        <div>
                                            <!-- Child has sub-children (3rd level) -->
                                            <template x-if="child.children && child.children.length > 0">
                                                <div>
                                                    <button @click="child.expanded = !child.expanded" 
                                                            class="flex items-center justify-between w-full text-left px-3 py-1.5 rounded-md text-gray-700 hover:bg-gray-100 transition-colors">
                                                        <span class="text-sm" x-text="child.name"></span>
                                                        <svg :class="child.expanded ? 'rotate-90' : 'rotate-0'" 
                                                             class="w-3 h-3 text-gray-400 transition-transform duration-200" 
                                                             fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    </button>
                                                    <div x-show="child.expanded" x-collapse class="ml-4 mt-1 space-y-0.5">
                                                        <template x-for="subchild in child.children" :key="subchild.id">
                                                            <a :href="subchild.href || '#'" 
                                                               :target="subchild.external ? '_blank' : '_self'"
                                                               :rel="subchild.external ? 'noopener noreferrer' : ''"
                                                               :class="isActive(subchild.href) ? 'block px-3 py-1 text-sm rounded-md bg-gray-100 text-brand-blue font-medium' : 'block px-3 py-1 text-sm text-gray-600 rounded-md hover:bg-gray-100 hover:text-brand-blue transition-colors'"
                                                               @click="mobileMenuOpen = false">
                                                                <span x-text="subchild.name"></span>
                                                                <span x-show="subchild.external" class="ml-1">â†—</span>
                                                            </a>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                            <!-- Child is a simple link (2nd level) -->
                                            <template x-if="!child.children || child.children.length === 0">
                                                <a :href="child.href || '#'" 
                                                   :target="child.external ? '_blank' : '_self'"
                                                   :rel="child.external ? 'noopener noreferrer' : ''"
                                                   :class="isActive(child.href) ? 'block px-3 py-1.5 text-sm rounded-md bg-gray-100 text-brand-blue font-medium' : 'block px-3 py-1.5 text-sm text-gray-600 rounded-md hover:bg-gray-100 hover:text-brand-blue transition-colors'"
                                                   @click="mobileMenuOpen = false">
                                                    <span x-text="child.name"></span>
                                                    <span x-show="child.external" class="ml-1">â†—</span>
                                                </a>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <!-- Section is a simple link -->
                        <template x-if="!section.children || section.children.length === 0">
                            <a :href="section.href || '#'" 
                               :target="section.external ? '_blank' : '_self'"
                               :rel="section.external ? 'noopener noreferrer' : ''"
                               :class="isActive(section.href) ? 'flex items-center w-full text-left px-3 py-2 rounded-lg bg-gray-100 text-brand-blue font-semibold' : 'flex items-center w-full text-left px-3 py-2 rounded-lg text-gray-900 hover:bg-gray-100 hover:text-brand-blue transition-colors'"
                               @click="mobileMenuOpen = false">
                                <span class="font-medium text-sm" x-text="section.name"></span>
                                <span x-show="section.external" class="ml-auto">â†—</span>
                            </a>
                        </template>
                    </div>
                </template>
            </nav>
            
            <!-- Mobile Menu Actions -->
            <div class="mt-8 pt-8 border-t border-gray-200 space-y-3">
                <a :href="'/contact'" 
                   @click="mobileMenuOpen = false"
                   class="block w-full px-4 py-2 text-sm font-semibold text-center rounded-md border-2 border-brand-blue bg-blue-50 text-gray-900 hover:bg-blue-100 transition duration-150 ease-in-out">
                    Contact
                </a>
                <a href="https://app.blue.cc" 
                   target="_blank"
                   class="block w-full px-4 py-2 text-sm font-semibold text-center rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out">
                    Log In
                </a>
                <a href="https://app.blue.cc" 
                   target="_blank"
                   class="block w-full px-4 py-2 text-sm font-semibold text-center rounded-md border border-transparent bg-brand-blue text-white hover:bg-brand-blue/90 transition duration-150 ease-in-out">
                    Sign Up
                </a>
            </div>
        </div>
    </div>
</div>
</div>
{{end}}