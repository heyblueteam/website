{{define "left-sidebar"}}
<!-- Flip char styles for security link effect -->
<style>
    .flip-char {
        display: inline-block;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .flip-char:hover {
        transform: scale(1.05);
    }
    .flip-char.glitching {
        animation: glitch 0.1s infinite;
    }
    @keyframes glitch {
        0% { transform: translateX(0); }
        25% { transform: translateX(-1px); }
        50% { transform: translateX(1px); }
        75% { transform: translateX(-0.5px); }
        100% { transform: translateX(0); }
    }
</style>

<!-- Left Sidebar - Folder Navigation -->
<nav x-data="{ 
         sections: {{.Navigation.Sections | toJSON}}.filter(s => s.id !== 'legal'),
         legalSection: {{.Navigation.Sections | toJSON}}.find(s => s.id === 'legal'),
         currentPath: window.location.pathname,
         isActive(href) {
             // Strip language prefix for comparison
             const pathWithoutLang = this.currentPath.replace(/^\/([a-z]{2}|[a-z]{2}-[A-Z]{2})(\/|$)/, '/');
             // Normalize both paths (remove trailing slashes for comparison)
             const normalizedCurrent = pathWithoutLang.replace(/\/$/, '') || '/';
             const normalizedHref = (href || '').replace(/\/$/, '') || '/';
             return normalizedCurrent === normalizedHref;
         },
         updateCurrentPath(newPath) {
             // Store the actual current path (which might include language prefix)
             this.currentPath = window.location.pathname;
             this.expandActiveParents();
         },
         init() {
             this.expandActiveParents();
         },
         expandActiveParents() {
             // Don't expand anything if we're on the home page
             const pathWithoutLang = this.currentPath.replace(/^\/([a-z]{2}|[a-z]{2}-[A-Z]{2})(\/|$)/, '/');
             const normalizedPath = pathWithoutLang.replace(/\/$/, '') || '/';
             if (normalizedPath === '/') {
                 // Collapse all sections when on home page
                 this.sections.forEach(section => {
                     section.expanded = false;
                     if (section.children) {
                         section.children.forEach(child => {
                             if (child.expanded) child.expanded = false;
                         });
                     }
                 });
                 return;
             }
             
             // Auto-expand sections and children that contain the active page
             this.sections.forEach(section => {
                 if (section.children) {
                     let hasActivePage = false;
                     section.children.forEach(child => {
                         if (child.children) {
                             let hasActiveSubPage = child.children.some(subchild => this.isActive(subchild.href));
                             if (hasActiveSubPage) {
                                 child.expanded = true;
                                 hasActivePage = true;
                             }
                         } else if (this.isActive(child.href)) {
                             hasActivePage = true;
                         }
                     });
                     if (hasActivePage) {
                         section.expanded = true;
                     }
                 }
             });
         }
     }"
     @collapse-sidebar-menus.window="() => {
         // Collapse all main sections
         sections.forEach(section => {
             section.expanded = false;
             if (section.children) {
                 section.children.forEach(child => {
                     child.expanded = false;
                 });
             }
         });
     }" 
     :class="sidebarsOpen ? 'translate-x-0 opacity-100' : '-translate-x-full opacity-0'"
     class="hidden lg:flex w-80 bg-white dark:bg-gray-900 overflow-y-auto transition-all duration-300 sticky top-16 h-[calc(100vh-4rem)] flex-col transform custom-scrollbar">
    <div class="p-4 pt-32 w-full flex-1">                
        <!-- Folder Structure -->
        <div class="space-y-1">
            <!-- Navigation Template -->
            <template x-for="section in sections" :key="section.id">
                <div class="folder-group">
                    <!-- Section has children -->
                    <template x-if="section.children && section.children.length > 0">
                        <div>
                            <button @click="sections.forEach(s => { if(s.id !== section.id) s.expanded = false; }); section.expanded = !section.expanded" 
                                    class="relative flex items-center w-full text-left px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150">
                                <svg :class="section.expanded ? 'rotate-90' : 'rotate-0'" 
                                     class="folder-icon mr-3 text-gray-400 dark:text-gray-500 transition-transform duration-200" 
                                     fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium text-sm" x-text="section.name"></span>
                            </button>
                            <div x-show="section.expanded" x-collapse class="ml-7 space-y-1">
                                <template x-for="child in section.children" :key="child.id">
                                    <div>
                                        <!-- Child has sub-children -->
                                        <template x-if="child.children && child.children.length > 0">
                                            <div>
                                                <button @click="child.expanded = !child.expanded" 
                                                        class="relative flex items-center w-full text-left px-3 py-1.5 rounded-md text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150">
                                                    <svg :class="child.expanded ? 'rotate-90' : 'rotate-0'" 
                                                         class="folder-icon mr-2 text-gray-400 dark:text-gray-500 w-4 h-4 transition-transform duration-200" 
                                                         fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    <span class="text-sm" x-text="child.name"></span>
                                                </button>
                                                <div x-show="child.expanded" x-collapse class="ml-6 space-y-0.5">
                                                    <template x-for="subchild in child.children" :key="subchild.id">
                                                        <a :href="subchild.href || '#'" 
                                                           :target="subchild.external ? '_blank' : '_self'"
                                                           :rel="subchild.external ? 'noopener noreferrer' : ''"
                                                           :class="isActive(subchild.href) ? 'nav-link relative block px-3 py-1 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium' : 'nav-link relative block px-3 py-1 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150'">
                                                            <span x-text="subchild.name"></span>
                                                            <span :class="subchild.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="subchild.external ? '‚Üó' : '‚Üí'"></span>
                                                        </a>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                        <!-- Child is a simple link -->
                                        <template x-if="!child.children || child.children.length === 0">
                                            <a :href="child.href || '#'" 
                                               :target="child.external ? '_blank' : '_self'"
                                               :rel="child.external ? 'noopener noreferrer' : ''"
                                               :class="isActive(child.href) ? 'nav-link relative block px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium' : 'nav-link relative block px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150'">
                                                <span x-text="child.name"></span>
                                                <span :class="child.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="child.external ? '‚Üó' : '‚Üí'"></span>
                                            </a>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    <!-- Section is a simple link -->
                    <template x-if="!section.children || section.children.length === 0">
                        <a :href="section.href || '#'" 
                           :target="section.external ? '_blank' : '_self'"
                           :rel="section.external ? 'noopener noreferrer' : ''"
                           :class="isActive(section.href) ? 'nav-link relative flex items-center w-full text-left px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-brand-blue font-semibold' : 'nav-link relative flex items-center w-full text-left px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150'">
                            <svg class="folder-icon mr-3 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium text-sm" x-text="section.name"></span>
                            <span :class="section.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="section.external ? '‚Üó' : '‚Üí'"></span>
                        </a>
                    </template>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Legal Section at Bottom - Dynamically Generated -->
    <div x-show="legalSection" class="p-4 mt-auto">
        <div x-data="{ expanded: legalSection?.expanded || false }" 
             @collapse-sidebar-menus.window="expanded = false"
             class="folder-group">
            <div x-show="expanded" x-collapse class="ml-7 space-y-0.5 order-first">
                <template x-for="item in (legalSection?.children || []).filter(child => child.href !== '/legal' && child.href !== '/legal/' && child.href !== '/legal/index')" :key="item.id">
                    <div>
                        <!-- Special rendering for Security link -->
                        <template x-if="item.href === '/legal/security'">
                            <a :href="item.href" 
                               :target="item.external ? '_blank' : '_self'"
                               :rel="item.external ? 'noopener noreferrer' : ''"
                               :class="isActive(item.href) ? 'nav-link relative block px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium' : 'nav-link relative block px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150'">
                                <template x-for="(char, charIndex) in 'Security'.split('')" :key="charIndex">
                                    <span 
                                        @mouseenter="window.flipChar($event)"
                                        class="flip-char"
                                        x-text="char">
                                    </span>
                                </template>
                                <span :class="item.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="item.external ? '‚Üó' : '‚Üí'"></span>
                            </a>
                        </template>
                        <!-- Special rendering for GDPR Compliance link -->
                        <template x-if="item.href === '/legal/gdpr'">
                            <a :href="item.href" 
                               :target="item.external ? '_blank' : '_self'"
                               :rel="item.external ? 'noopener noreferrer' : ''"
                               :class="isActive(item.href) ? 'nav-link relative block px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium group' : 'nav-link relative block px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150 group'">
                                <span x-text="item.name"></span>
                                <span class="ml-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">üá™üá∫</span>
                                <span :class="item.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="item.external ? '‚Üó' : '‚Üí'"></span>
                            </a>
                        </template>
                        <!-- Special rendering for HIPAA link -->
                        <template x-if="item.href === '/legal/hipaa'">
                            <a :href="item.href" 
                               :target="item.external ? '_blank' : '_self'"
                               :rel="item.external ? 'noopener noreferrer' : ''"
                               :class="isActive(item.href) ? 'nav-link relative block px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium group' : 'nav-link relative block px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150 group'">
                                <span x-text="item.name"></span>
                                <span class="ml-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">‚öïÔ∏è</span>
                                <span :class="item.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="item.external ? '‚Üó' : '‚Üí'"></span>
                            </a>
                        </template>
                        <!-- Special rendering for Privacy Policy link -->
                        <template x-if="item.href === '/legal/privacy'">
                            <a :href="item.href" 
                               :target="item.external ? '_blank' : '_self'"
                               :rel="item.external ? 'noopener noreferrer' : ''"
                               :class="isActive(item.href) ? 'nav-link relative block px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium' : 'nav-link relative block px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150'"
                               x-data="{ 
                                   text: 'Privacy Policy',
                                   masked: false,
                                   chars: [],
                                   init() {
                                       this.chars = this.text.split('').map((char, index) => ({
                                           char: char,
                                           masked: false,
                                           index: index
                                       }));
                                   },
                                   maskText() {
                                       this.masked = true;
                                       this.chars.forEach((char, index) => {
                                           setTimeout(() => {
                                               char.masked = true;
                                           }, index * 30);
                                       });
                                   },
                                   unmaskText() {
                                       this.masked = false;
                                       const totalChars = this.chars.length;
                                       this.chars.forEach((char, index) => {
                                           setTimeout(() => {
                                               this.chars[totalChars - 1 - index].masked = false;
                                           }, index * 30);
                                       });
                                   }
                               }"
                               @mouseenter="maskText()"
                               @mouseleave="unmaskText()">
                                <span class="inline-flex">
                                    <template x-for="char in chars" :key="char.index">
                                        <span class="inline-block transition-all duration-200"
                                              :style="char.char === ' ' ? 'width: 0.25rem;' : ''"
                                              x-text="char.char === ' ' ? ' ' : (char.masked ? '‚Ä¢' : char.char)">
                                        </span>
                                    </template>
                                </span>
                                <span :class="item.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="item.external ? '‚Üó' : '‚Üí'"></span>
                            </a>
                        </template>
                        <!-- Normal rendering for other links -->
                        <template x-if="item.href !== '/legal/security' && item.href !== '/legal/gdpr' && item.href !== '/legal/hipaa' && item.href !== '/legal/privacy'">
                            <a :href="item.href" 
                               :target="item.external ? '_blank' : '_self'"
                               :rel="item.external ? 'noopener noreferrer' : ''"
                               :class="isActive(item.href) ? 'nav-link relative block px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-brand-blue font-medium' : 'nav-link relative block px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150'">
                                <span x-text="item.name"></span>
                                <span :class="item.external ? 'nav-arrow-external' : 'nav-arrow'" x-text="item.external ? '‚Üó' : '‚Üí'"></span>
                            </a>
                        </template>
                    </div>
                </template>
            </div>
            <button @click="expanded = !expanded" 
                    class="relative flex items-center w-full text-left px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-brand-blue transition-colors duration-150">
                <svg :class="expanded ? '-rotate-90' : 'rotate-0'" 
                     class="folder-icon mr-3 text-gray-400 dark:text-gray-500 transition-transform duration-200" 
                     fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="font-medium text-sm" x-text="legalSection?.name || 'Legal'"></span>
            </button>
        </div>
    </div>
</nav>
{{end}}