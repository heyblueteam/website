{{- /* 
================================================================================
SEARCH BAR COMPONENT
================================================================================
Provides a centralized search interface with fuzzy search, keyboard navigation,
and quick suggestions.

USAGE:
{{template "search-bar" .}}

FEATURES:
- Fuzzy search using Fuse.js
- Keyboard navigation (arrow keys, enter, escape)
- Quick suggestions when focused with empty query
- Search result categories with color coding
- Prefetch on hover for performance
- Animated width expansion on focus
- Dark mode support
- Keyboard shortcut indicator (Cmd/Ctrl+K)

DATA STRUCTURE:
The component uses Alpine.js x-data with:
- query: Current search input
- results: Search results from Fuse.js
- fuse: Fuse.js instance
- showResults: Dropdown visibility
- selectedIndex: Keyboard navigation index
- loading: Loading state
- searchFocused: Focus state for width animation
- suggestions: Quick link suggestions
- showingSuggestions: Whether showing suggestions vs results

EVENTS:
Dispatches 'search-selected' event when a result or suggestion is selected,
allowing parent components to react (e.g., close mobile menu).

KEYBOARD SHORTCUTS:
- Cmd/Ctrl+K: Focus search input (handled by parent)
- Arrow Up/Down: Navigate results
- Enter: Select highlighted result
- Escape: Close dropdown

ANIMATION DETAILS:
- Width expansion: 18rem → 28rem on focus (300ms ease-out)
- Dropdown fade: 200ms enter, 150ms leave
- Smooth transitions for all states

STYLING:
- Positioned absolutely, centered horizontally
- Parent must provide relative positioning context
- Responsive: Hidden on mobile/tablet (lg:block)
- Uses brand colors for category badges

TECHNICAL NOTES:
- Loads search index from /searchIndex.json
- Debounced input (50ms) for performance
- Configurable Fuse.js weights for title/content/description
- Maximum 8 results displayed
- Blur delay (200ms) to allow click events

DEPENDENCIES:
- Alpine.js 3.x
- Fuse.js 7.0.0
- /searchIndex.json (generated by backend)
- /icons/sprite.svg (search, spinner icons)
*/ -}}
{{define "search-bar"}}
<div class="hidden lg:block absolute left-1/2 transform -translate-x-1/2"
     x-data="{
         query: '',
         results: [],
         fuse: null,
         showResults: false,
         selectedIndex: -1,
         loading: false,
         searchFocused: false,
         suggestions: [
             { title: 'Platform Overview', url: '/platform/', category: 'Feature', icon: 'grid', description: 'Explore Blue\'s capabilities' },
             { title: 'Features', url: '/platform/features/', category: 'Feature', icon: 'star', description: 'Discover all Blue features' },
             { title: 'Documentation', url: '/docs/start-guide/welcome', category: 'Docs', icon: 'book', description: 'Learn how to use Blue effectively' },
             { title: 'API Reference', url: '/api/start-guide/introduction', category: 'API', icon: 'code', description: 'Integrate with the Blue API' },
             { title: 'Contact Us', url: '/contact/', category: 'Page', icon: 'mail', description: 'Get in touch with our team' }
         ],
         showingSuggestions: false,
         async init() {
             try {
                 const response = await fetch('/searchIndex.json');
                 const data = await response.json();
                 this.fuse = new Fuse(data, {
                     keys: [
                         { name: 'title', weight: 0.7 },
                         { name: 'content', weight: 0.3 },
                         { name: 'description', weight: 0.5 }
                     ],
                     threshold: 0.3,
                     includeScore: true,
                     includeMatches: true
                 });
             } catch (error) {
                 console.error('Failed to load search index:', error);
             }
         },
         showSuggestions() {
             if (!this.query.trim()) {
                 this.showingSuggestions = true;
                 this.showResults = true;
                 this.results = [];
                 this.selectedIndex = -1;
             }
         },
         search() {
             this.showingSuggestions = false;
             if (!this.query.trim() || !this.fuse) {
                 this.results = [];
                 this.showResults = false;
                 return;
             }
             
             this.loading = true;
             this.results = this.fuse.search(this.query).slice(0, 8);
             this.showResults = true;
             this.selectedIndex = -1;
             this.loading = false;
         },
         selectResult(result) {
             // First hide the dropdown
             this.showResults = false;
             // Then animate search bar back after dropdown fade completes
             setTimeout(() => {
                 this.searchFocused = false;
                 this.query = '';
             }, 150);
             // Navigate after all animations complete (150ms dropdown + 300ms search bar = 450ms total)
             setTimeout(() => {
                 window.location.href = result.item.url;
             }, 450);
         },
         selectSuggestion(suggestion) {
             // First hide the dropdown
             this.showResults = false;
             // Then animate search bar back after dropdown fade completes
             setTimeout(() => {
                 this.searchFocused = false;
                 this.query = '';
             }, 150);
             // Navigate after all animations complete (150ms dropdown + 300ms search bar = 450ms total)
             setTimeout(() => {
                 window.location.href = suggestion.url;
             }, 450);
         },
         getCategoryClass(category) {
             // Use brand colors from brand.html
             const categoryColors = {
                 // Blue Blue (#00A0D2) for Features
                 'Feature': 'bg-[#00A0D2]/10 text-[#00A0D2] dark:bg-[#00A0D2]/20 dark:text-[#00A0D2]',
                 
                 // Aquamarine (#A9F0D1) for Docs and Solutions - darker text for readability
                 'Docs': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300',
                 'Solution': 'bg-[#A9F0D1]/20 text-green-700 dark:bg-[#A9F0D1]/20 dark:text-[#A9F0D1]',
                 
                 // Cyclamen (#F06C9B) for API
                 'API': 'bg-[#F06C9B]/10 text-[#F06C9B] dark:bg-[#F06C9B]/20 dark:text-[#F06C9B]',
                 
                 // Mustard (#FED766) for Insights - darker for readability
                 'Insights': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300',
                 
                 // Gray for Legal and Page
                 'Legal': 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300',
                 'Page': 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300'
             };
             return categoryColors[category] || 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300';
         },
         getSnippet(result) {
             const content = result.item.description || result.item.content || '';
             const queryWords = this.query.toLowerCase().split(' ');
             
             // Find first occurrence of query words
             let bestIndex = 0;
             for (let word of queryWords) {
                 const index = content.toLowerCase().indexOf(word);
                 if (index !== -1) {
                     bestIndex = Math.max(0, index - 40);
                     break;
                 }
             }
             
             const snippet = content.substring(bestIndex, bestIndex + 120);
             return bestIndex > 0 ? '...' + snippet + '...' : snippet + '...';
         },
         handleKeydown(event) {
             if (!this.showResults) return;
             
             const totalItems = this.showingSuggestions ? this.suggestions.length : this.results.length;
             
             if (event.key === 'ArrowDown') {
                 event.preventDefault();
                 this.selectedIndex = Math.min(this.selectedIndex + 1, totalItems - 1);
             } else if (event.key === 'ArrowUp') {
                 event.preventDefault();
                 this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
             } else if (event.key === 'Enter' && this.selectedIndex >= 0) {
                 event.preventDefault();
                 if (this.showingSuggestions) {
                     this.selectSuggestion(this.suggestions[this.selectedIndex]);
                 } else {
                     this.selectResult(this.results[this.selectedIndex]);
                 }
             } else if (event.key === 'Escape') {
                 this.showResults = false;
                 this.showingSuggestions = false;
                 this.selectedIndex = -1;
             }
         }
     }"
     @click.away="showResults = false; searchFocused = false; showingSuggestions = false">
    <div class="relative transition-all duration-300 ease-out"
         :class="searchFocused ? 'w-[28rem]' : 'w-72'">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="w-4 h-4 text-gray-400" fill="currentColor">
                <use href="/icons/sprite.svg#search"></use>
            </svg>
        </div>
        <input 
            type="text" 
            x-model="query"
            @input.debounce.50ms="search()"
            @keydown="handleKeydown($event)"
            @focus="searchFocused = true; showSuggestions(); query && search()"
            @blur="setTimeout(() => { if (!showResults) searchFocused = false }, 200)"
            class="block w-full pl-10 pr-16 py-2 border border-transparent bg-gray-100 dark:bg-gray-800 rounded-lg text-sm placeholder-gray-400 dark:placeholder-gray-500 text-gray-900 dark:text-gray-100 focus:outline-none focus:bg-white dark:focus:bg-gray-700 focus:border-gray-200 dark:focus:border-gray-700 transition-all duration-300"
            :placeholder="searchFocused ? 'Search docs, features, API, insights...' : 'Search...'"
            autocomplete="off"
            id="searchInput"
        >
        
        <!-- Keyboard shortcut indicator -->
        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none space-x-1"
             x-data="{ isMac: navigator.userAgent.indexOf('Mac') !== -1 }">
            <span x-show="isMac" class="inline-flex items-center justify-center w-5 h-5 bg-gray-200 rounded text-xs font-bold text-gray-400 border border-gray-300">⌘</span>
            <span x-show="!isMac" class="inline-flex items-center justify-center w-7 h-5 bg-gray-200 rounded text-xs font-bold text-gray-400 border border-gray-300">Ctrl</span>
            <span class="inline-flex items-center justify-center w-5 h-5 bg-gray-200 rounded text-xs font-bold text-gray-400 border border-gray-300">K</span>
        </div>
        
        <!-- Search Results Dropdown -->
        <div x-show="showResults" 
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-1"
             class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 max-h-96 overflow-y-auto z-50 custom-scrollbar">
            
            <template x-if="loading">
                <div class="p-4 text-center text-gray-500 text-sm">
                    <svg class="w-4 h-4 text-gray-400 animate-spin mr-2 inline-block" fill="currentColor">
                        <use href="/icons/sprite.svg#spinner"></use>
                    </svg>Searching...
                </div>
            </template>
            
            <template x-if="!loading && results.length === 0 && query">
                <div class="p-4 text-center text-gray-500 text-sm">
                    No results found for "<span x-text="query"></span>"
                </div>
            </template>
            
            <template x-if="!loading && showingSuggestions">
                <div class="py-2">
                    <div class="px-4 py-2 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                        Quick Links
                    </div>
                    <template x-for="(suggestion, index) in suggestions" :key="index">
                        <div @click="selectSuggestion(suggestion)"
                             @mouseenter="() => {
                                 const prefetchLink = document.createElement('link');
                                 prefetchLink.rel = 'prefetch';
                                 prefetchLink.href = suggestion.url;
                                 document.head.appendChild(prefetchLink);
                             }"
                             :class="selectedIndex === index ? 'bg-blue-50 dark:bg-blue-900/30' : 'hover:bg-blue-50 dark:hover:bg-blue-900/30'"
                             class="px-4 py-3 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0 transition-colors">
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-gray-100 text-sm" x-text="suggestion.title"></h4>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5" x-text="suggestion.description"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
            
            <template x-if="!loading && results.length > 0 && !showingSuggestions">
                <div class="py-2">
                    <template x-for="(result, index) in results" :key="index">
                        <div @click="selectResult(result)"
                             :class="selectedIndex === index ? 'bg-blue-50 dark:bg-blue-900/30' : 'hover:bg-blue-50 dark:hover:bg-blue-900/30'"
                             class="px-4 py-3 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0 transition-colors">
                            <div class="flex items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 text-sm" x-text="result.item.title"></h4>
                                        <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                                              :class="getCategoryClass(result.item.category)"
                                              x-show="result.item.category"
                                              x-text="result.item.category"></span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 line-clamp-2" x-text="getSnippet(result)"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
</div>
{{end}}