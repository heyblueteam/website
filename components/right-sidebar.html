{{define "right-sidebar"}}
<!-- Right Sidebar - Table of Contents -->
<aside :class="sidebarsOpen ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'"
       class="sticky top-16 h-[calc(100vh-4rem)] overflow-hidden transition-all duration-300 w-64 transform"
       x-data="{ 
           tocItems: {{toJSON .TOC}},
           activeSection: '',
           currentScrollY: 0,
           init() {
               // Initialize scroll position
               this.currentScrollY = window.scrollY;
               // Set up intersection observer for active section tracking
               this.setupScrollTracking();
               // Set up scroll tracking for arrow directions
               this.setupScrollListener();
           },
           setupScrollTracking() {
               if (this.tocItems.length === 0) return;
               
               const observer = new IntersectionObserver((entries) => {
                   entries.forEach(entry => {
                       if (entry.isIntersecting) {
                           this.activeSection = entry.target.id;
                       }
                   });
               }, {
                   rootMargin: '-20% 0% -35% 0%'
               });

               // Observe all heading elements
               this.tocItems.forEach(item => {
                   const element = document.getElementById(item.id);
                   if (element) {
                       observer.observe(element);
                   }
               });
           },
           setupScrollListener() {
               window.addEventListener('scroll', () => {
                   this.currentScrollY = window.scrollY;
               });
           },
           scrollToSection(anchor) {
               const element = document.getElementById(anchor);
               if (element) {
                   element.scrollIntoView({ behavior: 'smooth', block: 'start' });
               }
           },
           getArrowDirection(itemId) {
               const element = document.getElementById(itemId);
               if (!element) return '→';
               
               const elementTop = element.offsetTop;
               const viewportCenter = this.currentScrollY + (window.innerHeight / 2);
               
               return elementTop > viewportCenter ? '↓' : '↑';
           }
       }">
    <div class="pt-32 p-6 overflow-y-auto flex flex-col h-full">
        <div class="flex-1">
            <div x-show="tocItems.length > 0">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">On this page</h3>
                <nav class="space-y-1" id="toc-nav">
                    <template x-for="item in tocItems" :key="item.id">
                        <a :href="'#' + item.id" 
                           @click.prevent="scrollToSection(item.id)"
                           :class="activeSection === item.id ? 'text-brand-blue bg-blue-50 font-medium' : 'text-gray-600 hover:text-brand-blue'"
                           class="toc-link block text-sm px-2 py-1.5 rounded-md relative transition-colors duration-200">
                            <span x-text="item.title"></span>
                            <span class="toc-arrow transition-transform duration-200" x-text="getArrowDirection(item.id)"></span>
                        </a>
                    </template>
                </nav>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="flex justify-center mt-8">
            <a href="https://status.blue.cc" target="_blank" class="text-sm leading-6 text-gray-600 hover:text-gray-900 flex items-center">
                <span class="relative flex h-3 w-3 mr-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75" style="background-color: #00a0d2;"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3" style="background-color: #00a0d2;"></span>
                </span>
                System Status
            </a>
        </div>
    </div>
</aside>
{{end}}